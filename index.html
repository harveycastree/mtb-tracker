<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTB Route Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a25;
            --accent-primary: #00d4ff;
            --accent-secondary: #7c3aed;
            --accent-gradient: linear-gradient(135deg, #00d4ff 0%, #7c3aed 100%);
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --text-muted: #606070;
            --border-color: #2a2a3a;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            padding: 0.75rem 1.5rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            flex-wrap: wrap;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: var(--accent-gradient);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }

        .logo-text {
            font-size: 1.1rem;
            font-weight: 700;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
        }

        .header-btn {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.4rem 0.75rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .header-btn:hover {
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        .header-btn.active {
            background: rgba(0, 212, 255, 0.1);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .header-btn svg {
            width: 14px;
            height: 14px;
        }

        .header-stats {
            display: flex;
            gap: 1.5rem;
        }

        .stat {
            text-align: right;
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Main Layout */
        .main-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }

        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            min-height: 0;
        }

        /* Map and 3D Split */
        .view-container {
            flex: 1;
            display: flex;
            position: relative;
            min-height: 300px;
            height: 100%;      /* ensures children using height:100% have a reference */
            min-height: 0;     /* important in nested flex layouts */
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            position: absolute;
            inset: 0;
            background: var(--bg-secondary);
        }

        /* 3D Viewer Panel */
        .viewer-3d-panel {
            width: 320px;
            height: 100%;              /* KEY: lock to the view-container height */
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            display: none;
            flex-direction: column;
            position: relative;
            overflow: hidden;          /* prevents internal content forcing growth */
        }

        /* Draggable resize handle for 3D panel */
        .viewer-3d-resize-handle {
            position: absolute;
            left: -6px;
            top: 0;
            bottom: 0;
            width: 12px;
            cursor: ew-resize;
            z-index: 500;
        }
        .viewer-3d-resize-handle::after {
            content: '';
            position: absolute;
            left: 5px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border-color);
        }

        .viewer-3d-panel.visible {
            display: flex;
        }

        .viewer-3d-header {
            padding: 0.75rem 1rem;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .viewer-3d-title {
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .viewer-3d-controls {
            display: flex;
            gap: 0.25rem;
        }

        .amp-btn {
            padding: 0.25rem 0.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-secondary);
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .amp-btn:hover {
            border-color: var(--accent-primary);
        }

        .amp-btn.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        .viewer-3d-canvas-container {
            flex: 1;
            position: relative;
            min-height: 0;             /* KEY: stops flex child from forcing height growth */
            height: auto;
        }

        #viewer3d {
            display: block;            /* avoids inline-canvas layout quirks */
            width: 100%;
            height: 100%;
        }

        .model-upload-overlay {
            position: absolute;
            inset: 0;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            text-align: center;
        }

        .model-upload-overlay.hidden {
            display: none;
        }

        .model-upload-btn {
            padding: 0.6rem 1.2rem;
            background: var(--accent-gradient);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 0.75rem;
        }

        .model-upload-text {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        .rotation-stats {
            padding: 0.75rem 1rem;
            background: var(--bg-tertiary);
            border-top: 1px solid var(--border-color);
        }

        .rotation-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }

        .rotation-stat {
            text-align: center;
            padding: 0.5rem;
            background: var(--bg-secondary);
            border-radius: 6px;
        }

        .rotation-stat-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .rotation-stat-value {
            font-size: 1rem;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }

        .rotation-stat-value.roll { color: #ef4444; }
        .rotation-stat-value.pitch { color: #22c55e; }
        .rotation-stat-value.yaw { color: #3b82f6; }

        /* Axis Configuration */
        .axis-config {
            border-top: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .axis-config-header {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }

        .axis-config-header:hover {
            background: var(--bg-tertiary);
        }

        .axis-config.expanded .axis-config-header .expand-icon {
            transform: rotate(180deg);
        }

        .axis-config-content {
            display: none;
            padding: 0.75rem 1rem;
            background: var(--bg-primary);
        }

        .axis-config.expanded .axis-config-content {
            display: block;
        }

        .axis-config-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.75rem;
        }

        .axis-config-row label {
            color: var(--text-secondary);
            min-width: 90px;
        }

        .axis-config-row select {
            flex: 1;
            padding: 0.3rem 0.5rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 0.75rem;
        }

        .invert-label {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            min-width: auto !important;
            cursor: pointer;
        }

        .invert-label input {
            width: 14px;
            height: 14px;
            accent-color: var(--accent-primary);
        }

        .zero-btn {
            flex: 1;
            padding: 0.4rem 0.5rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-secondary);
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .zero-btn:hover {
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        .axis-preset-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-color);
            font-size: 0.75rem;
        }

        .axis-preset-row label {
            color: var(--text-secondary);
            min-width: 90px;
        }

        .axis-preset-row select {
            flex: 1;
            padding: 0.3rem 0.5rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 0.75rem;
        }

        /* Map Controls - Right Side */
        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 400;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .map-style-selector {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .map-style-btn {
            display: block;
            width: 100%;
            padding: 0.5rem 0.75rem;
            background: transparent;
            border: none;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 0.75rem;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }

        .map-style-btn:last-child {
            border-bottom: none;
        }

        .map-style-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .map-style-btn.active {
            background: rgba(0, 212, 255, 0.1);
            color: var(--accent-primary);
        }

        /* Data Panels Container */
        .data-panels {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            max-height: 50vh;
            overflow-y: auto;
        }

        .data-panels::-webkit-scrollbar {
            width: 6px;
        }

        .data-panels::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        .data-panels::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        /* Data Panel */
        .data-panel {
            border-bottom: 1px solid var(--border-color);
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: var(--bg-tertiary);
            cursor: pointer;
            transition: background 0.2s;
        }

        .panel-header:hover {
            background: var(--bg-primary);
        }

        .panel-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .panel-title-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .panel-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .unit-selector {
            padding: 0.25rem 0.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-secondary);
            font-size: 0.75rem;
            cursor: pointer;
        }

        .unit-selector:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .expand-icon {
            width: 20px;
            height: 20px;
            transition: transform 0.3s;
        }

        .data-panel.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .panel-content {
            height: 0;
            overflow: hidden;
            transition: height 0.3s ease;
        }

        .data-panel.expanded .panel-content {
            height: auto;
        }

        .chart-container {
            padding: 0.75rem 1rem;
            height: 180px;
        }

        .chart-container canvas {
            width: 100% !important;
            height: 100% !important;
        }

        /* Upload Overlay */
        .upload-overlay {
            position: absolute;
            inset: 0;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .upload-overlay.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .upload-container {
            text-align: center;
            max-width: 500px;
            padding: 2rem;
        }

        .upload-icon {
            width: 100px;
            height: 100px;
            margin: 0 auto 1.5rem;
            background: var(--bg-tertiary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed var(--border-color);
            transition: all 0.3s;
        }

        .upload-icon svg {
            width: 40px;
            height: 40px;
            stroke: var(--accent-primary);
        }

        .upload-container h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .upload-container p {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            line-height: 1.5;
            font-size: 0.9rem;
        }

        .upload-zone {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 2rem;
            background: var(--bg-secondary);
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--accent-primary);
            background: rgba(0, 212, 255, 0.05);
        }

        .upload-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: var(--accent-gradient);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 212, 255, 0.3);
        }

        .file-input {
            display: none;
        }

        .supported-formats {
            margin-top: 0.75rem;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Filter Panel */
        .filter-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 1rem;
            z-index: 500;
            min-width: 260px;
            display: none;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .filter-panel.visible {
            display: block;
        }

        .filter-panel h3 {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-group {
            margin-bottom: 0.75rem;
        }

        .filter-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.3rem;
        }

        .filter-value {
            color: var(--accent-primary);
            font-weight: 600;
        }

        .filter-slider {
            width: 100%;
            -webkit-appearance: none;
            height: 4px;
            border-radius: 2px;
            background: var(--bg-tertiary);
        }

        .filter-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--accent-primary);
            cursor: pointer;
        }

        .filter-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .filter-checkbox input {
            width: 16px;
            height: 16px;
            accent-color: var(--accent-primary);
        }

        .filter-checkbox span {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .filter-stats {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-color);
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .filter-stats .highlight {
            color: var(--accent-primary);
            font-weight: 600;
        }

        .apply-btn {
            width: 100%;
            margin-top: 0.75rem;
            padding: 0.6rem;
            background: var(--accent-gradient);
            border: none;
            border-radius: 6px;
            color: white;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
        }

        /* Playback Controls */
        .playback-panel {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            padding: 1rem 1.5rem;
        }

        .timeline-container {
            margin-bottom: 0.75rem;
        }

        .timeline-labels {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.4rem;
            font-size: 0.8rem;
        }

        .current-time {
            color: var(--accent-primary);
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }

        .total-time {
            color: var(--text-muted);
            font-variant-numeric: tabular-nums;
        }

        .timeline-track {
            position: relative;
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            cursor: pointer;
        }

        .timeline-progress {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: var(--accent-gradient);
            border-radius: 3px;
        }

        .timeline-scrubber {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            cursor: grab;
        }

        .controls-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .play-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--accent-gradient);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .play-btn:hover {
            transform: scale(1.08);
        }

        .play-btn svg {
            width: 20px;
            height: 20px;
            fill: white;
            margin-left: 2px;
        }

        .play-btn.playing svg {
            margin-left: 0;
        }

        .skip-btn {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .skip-btn:hover {
            border-color: var(--accent-primary);
        }

        .skip-btn svg {
            width: 16px;
            height: 16px;
            fill: var(--text-secondary);
        }

        .speed-controls {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .speed-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-right: 0.3rem;
        }

        .speed-btn {
            padding: 0.4rem 0.7rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
        }

        .speed-btn:hover {
            border-color: var(--accent-primary);
        }

        .speed-btn.active {
            background: var(--accent-gradient);
            border-color: transparent;
            color: white;
        }

        .route-info {
            display: flex;
            align-items: center;
            gap: 1.25rem;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .info-icon {
            width: 28px;
            height: 28px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .info-icon svg {
            width: 14px;
            height: 14px;
            stroke: var(--accent-primary);
        }

        .info-text {
            display: flex;
            flex-direction: column;
        }

        .info-value {
            font-weight: 600;
            font-size: 0.85rem;
        }

        .info-label {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            padding: 0.75rem 1.25rem;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .toast.visible {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }

        .toast.success { border-color: var(--success); }
        .toast.error { border-color: var(--danger); }

        /* Loading */
        .loading {
            position: absolute;
            inset: 0;
            background: rgba(10, 10, 15, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s;
        }

        .loading.visible {
            opacity: 1;
            visibility: visible;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--bg-tertiary);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            margin-top: 0.75rem;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Leaflet customization */
        .leaflet-container {
            background: var(--bg-secondary);
        }

        .custom-marker {
            background: var(--accent-gradient);
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 4px 12px rgba(0, 212, 255, 0.5);
        }

        .start-marker {
            background: var(--success);
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 2px solid white;
        }

        .end-marker {
            background: var(--danger);
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 2px solid white;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(0, 212, 255, 0.7); }
            50% { box-shadow: 0 0 0 12px rgba(0, 212, 255, 0); }
        }

        .position-marker {
            animation: pulse 2s infinite;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .viewer-3d-panel {
                width: 280px;
            }
        }

        @media (max-width: 768px) {
            .header-stats { display: none; }
            .route-info { display: none; }
            .viewer-3d-panel {
                position: absolute;
                right: 0;
                top: 0;
                bottom: 0;
                width: 280px;
                z-index: 450;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <div class="logo">
                <div class="logo-icon">üöµ</div>
                <span class="logo-text">MTB Tracker</span>
            </div>
            <div class="header-actions">
                <button class="header-btn" id="newFileBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                    </svg>
                    New
                </button>
                <button class="header-btn" id="filterBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                    </svg>
                    Filters
                </button>
                <button class="header-btn" id="graphsBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                    Graphs
                </button>
                <button class="header-btn" id="view3dBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5" />
                    </svg>
                    3D View
                </button>
            </div>
        </div>
        <div class="header-stats">
            <div class="stat">
                <div class="stat-label">GPS Points</div>
                <div class="stat-value" id="gpsPointsCount">--</div>
            </div>
            <div class="stat">
                <div class="stat-label">Duration</div>
                <div class="stat-value" id="totalDuration">--:--</div>
            </div>
            <div class="stat">
                <div class="stat-label">Distance</div>
                <div class="stat-value" id="totalDistance">-- km</div>
            </div>
        </div>
    </header>

    <div class="main-wrapper">
        <div class="content-area">
            <!-- Upload Overlay -->
            <div class="upload-overlay" id="uploadOverlay">
                <div class="upload-container">
                    <div class="upload-zone" id="uploadZone">
                        <div class="upload-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                            </svg>
                        </div>
                        <h2>Upload Your Ride Data</h2>
                        <p>Drop your CSV file here or click to browse. Visualize GPS, accelerometer, gyroscope and rotation data.</p>
                        <button class="upload-btn" id="uploadBtn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                            </svg>
                            Choose File
                        </button>
                        <p class="supported-formats">Supports CSV with GPS + IMU data</p>
                    </div>
                    <input type="file" class="file-input" id="fileInput" accept=".csv">
                </div>
            </div>

            <!-- Loading -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <div class="loading-text">Processing data...</div>
            </div>

            <!-- View Container -->
            <div class="view-container">
                <!-- Map Container -->
                <div class="map-container">
                    <div id="map"></div>
                    
                    <!-- Map Controls - Right Side -->
                    <div class="map-controls">
                        <div class="map-style-selector">
                            <button class="map-style-btn active" data-style="dark">üåô Dark</button>
                            <button class="map-style-btn" data-style="streets">üó∫Ô∏è Streets</button>
                            <button class="map-style-btn" data-style="satellite">üõ∞Ô∏è Satellite</button>
                            <button class="map-style-btn" data-style="terrain">‚õ∞Ô∏è Terrain</button>
                            <button class="map-style-btn" data-style="topo">üìç Topo</button>
                        </div>
                    </div>

                    <!-- Filter Panel -->
                    <div class="filter-panel" id="filterPanel">
                        <h3>üîß Filter Options</h3>
                        <div class="filter-group">
                            <label class="filter-label">
                                <span>Max Speed (m/s)</span>
                                <span class="filter-value" id="maxSpeedValue">50</span>
                            </label>
                            <input type="range" class="filter-slider" id="maxSpeedFilter" min="1" max="100" value="50">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">
                                <span>Min Satellites</span>
                                <span class="filter-value" id="minSatsValue">0</span>
                            </label>
                            <input type="range" class="filter-slider" id="minSatsFilter" min="0" max="15" value="0">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">
                                <span>Max HDOP</span>
                                <span class="filter-value" id="maxHdopValue">10</span>
                            </label>
                            <input type="range" class="filter-slider" id="maxHdopFilter" min="0.5" max="10" step="0.5" value="10">
                        </div>
                        <div class="filter-group">
                            <label class="filter-checkbox">
                                <input type="checkbox" id="removeStationary">
                                <span>Remove stationary (speed=0)</span>
                            </label>
                        </div>
                        <div class="filter-group">
                            <label class="filter-checkbox">
                                <input type="checkbox" id="removeJumps">
                                <span>Remove jumps (&gt;100m)</span>
                            </label>
                        </div>
                        <div class="filter-stats">
                            Points: <span class="highlight" id="filteredCount">0</span> / <span id="totalCount">0</span>
                        </div>
                        <button class="apply-btn" id="applyFilters">Apply Filters</button>
                    </div>
                </div>

                <!-- 3D Viewer Panel -->
                <div class="viewer-3d-panel" id="viewer3dPanel">
                  <div class="viewer-3d-resize-handle" id="viewer3dResizeHandle" title="Drag to resize"></div>
                    <div class="viewer-3d-header">
                        <div class="viewer-3d-title">
                            üö≤ Bike Orientation
                        </div>
                        <div class="viewer-3d-controls">
                            <span style="font-size: 0.7rem; color: var(--text-muted); margin-right: 0.25rem;">Amp:</span>
                            <button class="amp-btn active" data-amp="1">1√ó</button>
                            <button class="amp-btn" data-amp="2">2√ó</button>
                            <button class="amp-btn" data-amp="3">3√ó</button>
                            <button class="amp-btn" data-amp="5">5√ó</button>
                        </div>
                    </div>
                    <div class="viewer-3d-canvas-container">
                        <canvas id="viewer3d"></canvas>
                        <div class="model-upload-overlay" id="modelUploadOverlay">
                            <div style="font-size: 2rem;">üö≤</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem;">Load your bike model</div>
                            <button class="model-upload-btn" id="modelUploadBtn">Upload GLB</button>
                            <div class="model-upload-text">or use default cube</div>
                            <button class="model-upload-btn" id="useDefaultBtn" style="background: var(--bg-tertiary); margin-top: 0.5rem;">Use Default</button>
                            <input type="file" id="modelFileInput" accept=".glb,.gltf" style="display: none;">
                        </div>
                    </div>
                    <div class="rotation-stats">
                        <div class="rotation-stats-grid">
                            <div class="rotation-stat">
                                <div class="rotation-stat-label">Roll (Lean)</div>
                                <div class="rotation-stat-value roll" id="rollValue">0.0¬∞</div>
                            </div>
                            <div class="rotation-stat">
                                <div class="rotation-stat-label">Pitch</div>
                                <div class="rotation-stat-value pitch" id="pitchValue">0.0¬∞</div>
                            </div>
                            <div class="rotation-stat">
                                <div class="rotation-stat-label">Yaw</div>
                                <div class="rotation-stat-value yaw" id="yawValue">0.0¬∞</div>
                            </div>
                        </div>
                    </div>
                    <!-- Rotation Enable Toggles -->
                    <div class="rotation-stats" style="border-top: 1px solid var(--border-color);">
                        <div style="display:flex; gap:0.5rem; justify-content:space-between;">
                            <label class="invert-label" style="color: var(--text-secondary); font-size:0.75rem;">
                                <input type="checkbox" id="enableRoll" checked> Enable Roll
                            </label>
                            <label class="invert-label" style="color: var(--text-secondary); font-size:0.75rem;">
                                <input type="checkbox" id="enablePitch" checked> Enable Pitch
                            </label>
                            <label class="invert-label" style="color: var(--text-secondary); font-size:0.75rem;">
                                <input type="checkbox" id="enableYaw" checked> Enable Yaw
                            </label>
                        </div>
                    </div>
                    <!-- Axis Configuration -->
                    <div class="axis-config">
                        <div class="axis-config-header" id="axisConfigToggle">
                            <span>‚öôÔ∏è IMU Axis Mapping</span>
                            <svg class="expand-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                            </svg>
                        </div>
                        <div class="axis-config-content" id="axisConfigContent">
                            <div class="axis-config-row">
                                <label>Roll (lean L/R):</label>
                                <select id="rollAxis">
                                    <option value="x">X axis</option>
                                    <option value="y" selected>Y axis</option>
                                    <option value="z">Z axis</option>
                                </select>
                                <label class="invert-label"><input type="checkbox" id="rollInvert"> Invert</label>
                            </div>
                            <div class="axis-config-row">
                                <label>Pitch (fwd/back):</label>
                                <select id="pitchAxis">
                                    <option value="x" selected>X axis</option>
                                    <option value="y">Y axis</option>
                                    <option value="z">Z axis</option>
                                </select>
                                <label class="invert-label"><input type="checkbox" id="pitchInvert"> Invert</label>
                            </div>
                            <div class="axis-config-row">
                                <label>Yaw (heading):</label>
                                <select id="yawAxis">
                                    <option value="x">X axis</option>
                                    <option value="y">Y axis</option>
                                    <option value="z" selected>Z axis</option>
                                </select>
                                <label class="invert-label"><input type="checkbox" id="yawInvert"> Invert</label>
                            </div>
                            <div class="axis-config-row">
                                <label>Zero offset:</label>
                                <button class="zero-btn" id="zeroRotationBtn">Set Current as Zero</button>
                            </div>
                            <div class="axis-preset-row">
                                <label>Presets:</label>
                                <select id="axisPreset">
                                    <option value="custom">Custom</option>
                                    <option value="standard">Standard (X-fwd)</option>
                                    <option value="yourdevice" selected>Your Device (Y-fwd, X-left)</option>
                                    <option value="rotated180">Rotated 180¬∞</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Panels -->
            <div class="data-panels" id="dataPanels" style="display: none;">
                <!-- Elevation Panel -->
                <div class="data-panel" data-panel="elevation">
                    <div class="panel-header">
                        <div class="panel-title">
                            <span class="panel-title-icon" style="background: rgba(16, 185, 129, 0.2);">‚õ∞Ô∏è</span>
                            <span>Elevation Profile</span>
                        </div>
                        <div class="panel-controls">
                            <select class="unit-selector" id="elevationUnit">
                                <option value="m">Meters</option>
                                <option value="ft">Feet</option>
                            </select>
                            <svg class="expand-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                            </svg>
                        </div>
                    </div>
                    <div class="panel-content">
                        <div class="chart-container">
                            <canvas id="elevationChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Speed Panel -->
                <div class="data-panel" data-panel="speed">
                    <div class="panel-header">
                        <div class="panel-title">
                            <span class="panel-title-icon" style="background: rgba(245, 158, 11, 0.2);">‚ö°</span>
                            <span>Speed</span>
                        </div>
                        <div class="panel-controls">
                            <select class="unit-selector" id="speedUnit">
                                <option value="mps">m/s</option>
                                <option value="kmh">km/h</option>
                                <option value="mph">mph</option>
                            </select>
                            <svg class="expand-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                            </svg>
                        </div>
                    </div>
                    <div class="panel-content">
                        <div class="chart-container">
                            <canvas id="speedChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Acceleration Panel -->
                <div class="data-panel" data-panel="acceleration">
                    <div class="panel-header">
                        <div class="panel-title">
                            <span class="panel-title-icon" style="background: rgba(239, 68, 68, 0.2);">üìä</span>
                            <span>Acceleration (IMU)</span>
                        </div>
                        <div class="panel-controls">
                            <svg class="expand-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                            </svg>
                        </div>
                    </div>
                    <div class="panel-content">
                        <div class="chart-container">
                            <canvas id="accelChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- G-Force Panel -->
                <div class="data-panel" data-panel="gforce">
                    <div class="panel-header">
                        <div class="panel-title">
                            <span class="panel-title-icon" style="background: rgba(236, 72, 153, 0.2);">üí•</span>
                            <span>G-Force (Total)</span>
                        </div>
                        <div class="panel-controls">
                            <svg class="expand-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                            </svg>
                        </div>
                    </div>
                    <div class="panel-content">
                        <div class="chart-container">
                            <canvas id="gforceChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Gyroscope Panel -->
                <div class="data-panel" data-panel="gyroscope">
                    <div class="panel-header">
                        <div class="panel-title">
                            <span class="panel-title-icon" style="background: rgba(139, 92, 246, 0.2);">üîÑ</span>
                            <span>Gyroscope (Rotation Rate)</span>
                        </div>
                        <div class="panel-controls">
                            <svg class="expand-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                            </svg>
                        </div>
                    </div>
                    <div class="panel-content">
                        <div class="chart-container">
                            <canvas id="gyroChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Heading/Course Panel -->
                <div class="data-panel" data-panel="heading">
                    <div class="panel-header">
                        <div class="panel-title">
                            <span class="panel-title-icon" style="background: rgba(0, 212, 255, 0.2);">üß≠</span>
                            <span>Heading / Course</span>
                        </div>
                        <div class="panel-controls">
                            <svg class="expand-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                            </svg>
                        </div>
                    </div>
                    <div class="panel-content">
                        <div class="chart-container">
                            <canvas id="headingChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Playback Panel -->
        <div class="playback-panel">
            <div class="timeline-container">
                <div class="timeline-labels">
                    <span class="current-time" id="currentTime">00:00</span>
                    <span class="total-time" id="endTime">00:00</span>
                </div>
                <div class="timeline-track" id="timelineTrack">
                    <div class="timeline-progress" id="timelineProgress"></div>
                    <div class="timeline-scrubber" id="timelineScrubber"></div>
                </div>
            </div>
            <div class="controls-row">
                <div class="control-group">
                    <button class="skip-btn" id="skipBackBtn" title="Skip to start">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path d="M19 5v14l-11-7 11-7zM5 5h2v14H5V5z"/>
                        </svg>
                    </button>
                    <button class="play-btn" id="playBtn" title="Play/Pause">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="playIcon">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                    </button>
                    <button class="skip-btn" id="skipEndBtn" title="Skip to end">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path d="M5 5v14l11-7L5 5zm12 0v14h2V5h-2z"/>
                        </svg>
                    </button>
                </div>
                <div class="speed-controls">
                    <span class="speed-label">Speed:</span>
                    <button class="speed-btn active" data-speed="1">1√ó</button>
                    <button class="speed-btn" data-speed="2">2√ó</button>
                    <button class="speed-btn" data-speed="5">5√ó</button>
                    <button class="speed-btn" data-speed="10">10√ó</button>
                </div>
                <div class="route-info">
                    <div class="info-item">
                        <div class="info-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                            </svg>
                        </div>
                        <div class="info-text">
                            <span class="info-value" id="currentSpeedInfo">-- m/s</span>
                            <span class="info-label">Speed</span>
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                            </svg>
                        </div>
                        <div class="info-text">
                            <span class="info-value" id="currentAltitude">-- m</span>
                            <span class="info-label">Altitude</span>
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5" />
                            </svg>
                        </div>
                        <div class="info-text">
                            <span class="info-value" id="currentGForce">-- G</span>
                            <span class="info-label">G-Force</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <span id="toastMessage">Success!</span>
    </div>

    <script>
        // ==================== State ====================
        let map = null;
        let currentTileLayer = null;
        let routeLine = null;
        let positionMarker = null;
        let startMarker = null;
        let endMarker = null;
        
        let rawGpsData = [];
        let gpsData = [];
        let accData = [];
        let gyroData = [];
        let rotData = [];
        let imuTimeline = [];   // master playback timeline (ROT-time) with interpolated GPS fields
        
        let isPlaying = false;
        let playbackSpeed = 1;
        let currentIndex = 0;
        let animationFrame = null;
        let lastTimestamp = 0;
        let accumulatedTime = 0;
        
        let charts = {};
        let graphsVisible = false;
        let viewer3dVisible = false;
        
        // 3D Viewer
        let scene, camera, renderer, bikeModel;
        let rotationAmplifier = 1;
        let modelLoaded = false;

        // Rotation enable flags (for isolating roll/pitch/yaw)
        let rotationEnable = {
            roll: true,
            pitch: true,
            yaw: true
        };
        
        // Axis mapping configuration
        let axisConfig = {
            roll: 'y',    // Which IMU axis maps to roll (lean)
            pitch: 'x',   // Which IMU axis maps to pitch
            yaw: 'z',     // Which IMU axis maps to yaw
            rollInvert: false,
            pitchInvert: false,
            yawInvert: false
        };
        let rotationOffset = { roll: 0, pitch: 0, yaw: 0 };

        // Map tile providers
        const mapStyles = {
            dark: { url: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', attribution: '¬© OpenStreetMap ¬© CARTO' },
            streets: { url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', attribution: '¬© OpenStreetMap' },
            satellite: { url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', attribution: '¬© Esri' },
            terrain: { url: 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', attribution: '¬© OpenTopoMap' },
            topo: { url: 'https://{s}.tile.thunderforest.com/outdoors/{z}/{x}/{y}.png?apikey=6170aad10dfd42a38d4d8c709a536f38', attribution: '¬© Thunderforest' }
        };

        // ==================== DOM Elements ====================
        const uploadOverlay = document.getElementById('uploadOverlay');
        const uploadZone = document.getElementById('uploadZone');
        const uploadBtn = document.getElementById('uploadBtn');
        const fileInput = document.getElementById('fileInput');
        const loading = document.getElementById('loading');
        const playBtn = document.getElementById('playBtn');
        const playIcon = document.getElementById('playIcon');
        const timelineTrack = document.getElementById('timelineTrack');
        const timelineProgress = document.getElementById('timelineProgress');
        const timelineScrubber = document.getElementById('timelineScrubber');
        const currentTimeEl = document.getElementById('currentTime');
        const endTimeEl = document.getElementById('endTime');
        const speedBtns = document.querySelectorAll('.speed-btn');
        const newFileBtn = document.getElementById('newFileBtn');
        const filterBtn = document.getElementById('filterBtn');
        const filterPanel = document.getElementById('filterPanel');
        const graphsBtn = document.getElementById('graphsBtn');
        const dataPanels = document.getElementById('dataPanels');
        const view3dBtn = document.getElementById('view3dBtn');
        const viewer3dPanel = document.getElementById('viewer3dPanel');
        const viewer3dResizeHandle = document.getElementById('viewer3dResizeHandle');
        const toast = document.getElementById('toast');

        // ==================== Toast ====================
        function showToast(message, type = 'success') {
            document.getElementById('toastMessage').textContent = message;
            toast.className = 'toast visible ' + type;
            setTimeout(() => toast.classList.remove('visible'), 3000);
        }

        // ==================== Map ====================
        function initMap() {
            map = L.map('map', { zoomControl: true, maxZoom: 22, minZoom: 1 }).setView([51.505, -0.09], 13);
            setMapStyle('dark');
        }

        function setMapStyle(style) {
            if (currentTileLayer) map.removeLayer(currentTileLayer);
            const config = mapStyles[style];
            currentTileLayer = L.tileLayer(config.url, { attribution: config.attribution, maxZoom: 22 }).addTo(map);
            document.querySelectorAll('.map-style-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.style === style));
        }

        document.querySelectorAll('.map-style-btn').forEach(btn => {
            btn.addEventListener('click', () => setMapStyle(btn.dataset.style));
        });

        // ==================== 3D Viewer ====================
        function init3DViewer() {
            const canvas = document.getElementById('viewer3d');
            const container = canvas.parentElement;
            
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x12121a);
            
            camera = new THREE.PerspectiveCamera(50, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(0, 0, 3);
            camera.lookAt(0, 0, 0);
            
            renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            
            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 5, 5);
            scene.add(directionalLight);
            
            const backLight = new THREE.DirectionalLight(0x00d4ff, 0.3);
            backLight.position.set(-5, -5, -5);
            scene.add(backLight);
            
            // Grid helper
            const gridHelper = new THREE.GridHelper(4, 10, 0x2a2a3a, 0x2a2a3a);
            gridHelper.rotation.x = Math.PI / 2;
            gridHelper.position.z = -1;
            scene.add(gridHelper);
            
            animate3D();
        }

        function animate3D() {
            requestAnimationFrame(animate3D);
            if (renderer && scene && camera) {
                renderer.render(scene, camera);
            }
        }

        function resize3DViewer() {
            if (!renderer || !camera) return;
            const container = document.getElementById('viewer3d').parentElement;
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }

        function loadDefaultModel() {
            // Create a simple bike-like shape
            const group = new THREE.Group();
            
            // Frame
            const frameMaterial = new THREE.MeshStandardMaterial({ color: 0x00d4ff, metalness: 0.5, roughness: 0.5 });
            
            // Main tube
            const tubeGeom = new THREE.CylinderGeometry(0.03, 0.03, 1, 8);
            const mainTube = new THREE.Mesh(tubeGeom, frameMaterial);
            mainTube.rotation.z = Math.PI / 6;
            mainTube.position.set(0, 0.1, 0);
            group.add(mainTube);
            
            // Down tube
            const downTube = new THREE.Mesh(tubeGeom, frameMaterial);
            downTube.rotation.z = -Math.PI / 4;
            downTube.position.set(-0.1, -0.15, 0);
            downTube.scale.y = 0.7;
            group.add(downTube);
            
            // Seat tube
            const seatTube = new THREE.Mesh(tubeGeom, frameMaterial);
            seatTube.position.set(0.25, 0.1, 0);
            seatTube.scale.y = 0.6;
            group.add(seatTube);
            
            // Wheels
            const wheelGeom = new THREE.TorusGeometry(0.3, 0.03, 8, 24);
            const wheelMaterial = new THREE.MeshStandardMaterial({ color: 0x333333 });
            
            const frontWheel = new THREE.Mesh(wheelGeom, wheelMaterial);
            frontWheel.position.set(-0.5, -0.3, 0);
            group.add(frontWheel);
            
            const rearWheel = new THREE.Mesh(wheelGeom, wheelMaterial);
            rearWheel.position.set(0.5, -0.3, 0);
            group.add(rearWheel);
            
            // Handlebars
            const handleGeom = new THREE.CylinderGeometry(0.02, 0.02, 0.4, 8);
            const handleMaterial = new THREE.MeshStandardMaterial({ color: 0x666666 });
            const handlebar = new THREE.Mesh(handleGeom, handleMaterial);
            handlebar.rotation.x = Math.PI / 2;
            handlebar.position.set(-0.4, 0.35, 0);
            group.add(handlebar);
            
            group.scale.set(1.2, 1.2, 1.2);
            
            if (bikeModel) scene.remove(bikeModel);
            bikeModel = group;
            scene.add(bikeModel);
            modelLoaded = true;
            document.getElementById('modelUploadOverlay').classList.add('hidden');
        }

        function loadGLBModel(file) {
            const loader = new THREE.GLTFLoader();
            const url = URL.createObjectURL(file);
            
            loader.load(url, (gltf) => {
                if (bikeModel) scene.remove(bikeModel);
                bikeModel = gltf.scene;
                
                // Center and scale the model
                const box = new THREE.Box3().setFromObject(bikeModel);
                const center = box.getCenter(new THREE.Vector3());
                const size = box.getSize(new THREE.Vector3());
                const maxDim = Math.max(size.x, size.y, size.z);
                const scale = 2 / maxDim;
                
                bikeModel.scale.setScalar(scale);
                bikeModel.position.sub(center.multiplyScalar(scale));
                
                scene.add(bikeModel);
                modelLoaded = true;
                document.getElementById('modelUploadOverlay').classList.add('hidden');
                showToast('Model loaded successfully');
                URL.revokeObjectURL(url);
            }, undefined, (error) => {
                console.error('Error loading model:', error);
                showToast('Error loading model', 'error');
            });
        }

        function loadGLBModelFromUrl(url) {
            const loader = new THREE.GLTFLoader();

            loader.load(url, (gltf) => {
                if (bikeModel) scene.remove(bikeModel);
                bikeModel = gltf.scene;

                // Center and scale the model
                const box = new THREE.Box3().setFromObject(bikeModel);
                const center = box.getCenter(new THREE.Vector3());
                const size = box.getSize(new THREE.Vector3());
                const maxDim = Math.max(size.x, size.y, size.z);
                const scale = 2 / maxDim;

                bikeModel.scale.setScalar(scale);
                bikeModel.position.sub(center.multiplyScalar(scale));

                scene.add(bikeModel);
                modelLoaded = true;
                document.getElementById('modelUploadOverlay').classList.add('hidden');
                showToast('Model loaded successfully');
            }, undefined, (error) => {
                console.error('Error loading model:', error);
                showToast('Error loading model', 'error');
            });
        }

        function applyRotationToModel(rotPoint) {
            if (!bikeModel || !modelLoaded || !rotPoint) return;

            // Get quaternion from data
            let { x, y, z, w } = rotPoint;

            // Create quaternion and extract Euler angles
            const quaternion = new THREE.Quaternion(x, y, z, w);
            const euler = new THREE.Euler().setFromQuaternion(quaternion, 'XYZ');

            // Map axes based on configuration
            const axisValues = {
                x: euler.x * 180 / Math.PI,
                y: euler.y * 180 / Math.PI,
                z: euler.z * 180 / Math.PI
            };

            let roll  = axisValues[axisConfig.roll];
            let pitch = axisValues[axisConfig.pitch];
            let yaw   = axisValues[axisConfig.yaw];

            if (axisConfig.rollInvert) roll = -roll;
            if (axisConfig.pitchInvert) pitch = -pitch;
            if (axisConfig.yawInvert) yaw = -yaw;

            roll  -= rotationOffset.roll;
            pitch -= rotationOffset.pitch;
            yaw   -= rotationOffset.yaw;

            roll  *= rotationAmplifier;
            pitch *= rotationAmplifier;
            yaw   *= rotationAmplifier;

            // If you implemented axis enable/disable earlier:
            if (typeof rotationEnable !== 'undefined') {
                if (!rotationEnable.roll)  roll = 0;
                if (!rotationEnable.pitch) pitch = 0;
                if (!rotationEnable.yaw)   yaw = 0;
            }

            roll  = ((roll + 180) % 360) - 180;
            pitch = ((pitch + 180) % 360) - 180;
            yaw   = ((yaw + 180) % 360) - 180;

            bikeModel.rotation.set(
                pitch * Math.PI / 180,
                yaw   * Math.PI / 180,
                roll  * Math.PI / 180
            );

            document.getElementById('rollValue').textContent  = roll.toFixed(1) + '¬∞';
            document.getElementById('pitchValue').textContent = pitch.toFixed(1) + '¬∞';
            document.getElementById('yawValue').textContent   = yaw.toFixed(1) + '¬∞';
        }

        function updateBikeRotation(time) {
            if (!bikeModel || !modelLoaded || rotData.length === 0) return;

            const rotPoint = findClosestData(rotData, time);
            if (!rotPoint) return;

            applyRotationToModel(rotPoint);
        }

        function updateBikeRotationFromTimeline(time) {
            if (!bikeModel || !modelLoaded || imuTimeline.length === 0) return;

            // Find closest timeline entry to this time (fast enough; timeline is already IMU-based)
            // You can optimise with an index search, but this is fine given you already track currentIndex.
            const idx = currentIndex;
            const item = imuTimeline[idx];
            if (!item || !item.rot) return;

            // Reuse your existing quaternion->euler mapping logic by temporarily passing a rotPoint-like object
            // (We call the core rotation code by using the existing updateBikeRotation() structure.)
            const rotPoint = { x: item.rot.x, y: item.rot.y, z: item.rot.z, w: item.rot.w };
            applyRotationToModel(rotPoint);
        }


        // Rotation enable UI
        document.getElementById('enableRoll')?.addEventListener('change', (e) => {
            rotationEnable.roll = e.target.checked;
        });
        document.getElementById('enablePitch')?.addEventListener('change', (e) => {
            rotationEnable.pitch = e.target.checked;
        });
        document.getElementById('enableYaw')?.addEventListener('change', (e) => {
            rotationEnable.yaw = e.target.checked;
        });

        // Axis configuration UI
        document.getElementById('axisConfigToggle')?.addEventListener('click', () => {
            document.querySelector('.axis-config').classList.toggle('expanded');
        });

        document.getElementById('rollAxis')?.addEventListener('change', (e) => {
            axisConfig.roll = e.target.value;
            document.getElementById('axisPreset').value = 'custom';
        });
        document.getElementById('pitchAxis')?.addEventListener('change', (e) => {
            axisConfig.pitch = e.target.value;
            document.getElementById('axisPreset').value = 'custom';
        });
        document.getElementById('yawAxis')?.addEventListener('change', (e) => {
            axisConfig.yaw = e.target.value;
            document.getElementById('axisPreset').value = 'custom';
        });
        document.getElementById('rollInvert')?.addEventListener('change', (e) => {
            axisConfig.rollInvert = e.target.checked;
            document.getElementById('axisPreset').value = 'custom';
        });
        document.getElementById('pitchInvert')?.addEventListener('change', (e) => {
            axisConfig.pitchInvert = e.target.checked;
            document.getElementById('axisPreset').value = 'custom';
        });
        document.getElementById('yawInvert')?.addEventListener('change', (e) => {
            axisConfig.yawInvert = e.target.checked;
            document.getElementById('axisPreset').value = 'custom';
        });

        document.getElementById('zeroRotationBtn')?.addEventListener('click', () => {
            if (rotData.length === 0 || gpsData.length === 0) return;
            
            const currentTime = gpsData[currentIndex]?.time || 0;
            const rotPoint = findClosestData(rotData, currentTime);
            if (!rotPoint) return;
            
            const quaternion = new THREE.Quaternion(rotPoint.x, rotPoint.y, rotPoint.z, rotPoint.w);
            const euler = new THREE.Euler().setFromQuaternion(quaternion, 'XYZ');
            
            const axisValues = {
                x: euler.x * 180 / Math.PI,
                y: euler.y * 180 / Math.PI,
                z: euler.z * 180 / Math.PI
            };
            
            rotationOffset.roll = axisValues[axisConfig.roll] * (axisConfig.rollInvert ? -1 : 1);
            rotationOffset.pitch = axisValues[axisConfig.pitch] * (axisConfig.pitchInvert ? -1 : 1);
            rotationOffset.yaw = axisValues[axisConfig.yaw] * (axisConfig.yawInvert ? -1 : 1);
            
            showToast('Zero offset set from current position');
        });

        document.getElementById('axisPreset')?.addEventListener('change', (e) => {
            const preset = e.target.value;
            switch (preset) {
                case 'standard':
                    axisConfig = { roll: 'z', pitch: 'x', yaw: 'y', rollInvert: false, pitchInvert: false, yawInvert: false };
                    break;
                case 'yourdevice':
                    // Y+ forward, X+ left, Z+ up
                    axisConfig = { roll: 'y', pitch: 'x', yaw: 'z', rollInvert: false, pitchInvert: false, yawInvert: false };
                    break;
                case 'rotated180':
                    axisConfig = { roll: 'y', pitch: 'x', yaw: 'z', rollInvert: true, pitchInvert: true, yawInvert: false };
                    break;
                default:
                    return;
            }
            // Update UI
            document.getElementById('rollAxis').value = axisConfig.roll;
            document.getElementById('pitchAxis').value = axisConfig.pitch;
            document.getElementById('yawAxis').value = axisConfig.yaw;
            document.getElementById('rollInvert').checked = axisConfig.rollInvert;
            document.getElementById('pitchInvert').checked = axisConfig.pitchInvert;
            document.getElementById('yawInvert').checked = axisConfig.yawInvert;
        });

        // 3D View button
        view3dBtn.addEventListener('click', () => {
            viewer3dVisible = !viewer3dVisible;
            view3dBtn.classList.toggle('active', viewer3dVisible);
            viewer3dPanel.classList.toggle('visible', viewer3dVisible);
            
            if (viewer3dVisible && !scene) {
                setTimeout(() => {
                    init3DViewer();
                    loadGLBModelFromUrl('assets/santa_cruz_v10_downhill_mountain_bicycle.glb');
                    resize3DViewer();
                }, 100);
            } else if (viewer3dVisible) {
                setTimeout(resize3DViewer, 100);
            }
        });

        // Amplifier buttons
        document.querySelectorAll('.amp-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.amp-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                rotationAmplifier = parseInt(btn.dataset.amp);
            });
        });

        // Model upload
        document.getElementById('modelUploadBtn').addEventListener('click', () => {
            document.getElementById('modelFileInput').click();
        });

        document.getElementById('modelFileInput').addEventListener('change', (e) => {
            if (e.target.files[0]) loadGLBModel(e.target.files[0]);
        });

        document.getElementById('useDefaultBtn').addEventListener('click', loadDefaultModel);

        // ==================== File Handling ====================
        uploadBtn.addEventListener('click', () => fileInput.click());
        uploadZone.addEventListener('click', (e) => { if (e.target !== uploadBtn) fileInput.click(); });
        uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('dragover'); });
        uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            if (e.dataTransfer.files[0]?.name.endsWith('.csv')) processFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', (e) => { if (e.target.files[0]) processFile(e.target.files[0]); });

        newFileBtn.addEventListener('click', () => {
            stopPlayback();
            rawGpsData = []; gpsData = []; accData = []; gyroData = []; rotData = []; imuTimeline = [];
            if (routeLine) map.removeLayer(routeLine);
            if (positionMarker) map.removeLayer(positionMarker);
            if (startMarker) map.removeLayer(startMarker);
            if (endMarker) map.removeLayer(endMarker);
            uploadOverlay.classList.remove('hidden');
            filterPanel.classList.remove('visible');
            dataPanels.style.display = 'none';
            graphsBtn.classList.remove('active');
            graphsVisible = false;
            fileInput.value = '';
        });

        function processFile(file) {
            loading.classList.add('visible');
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    parseCSV(e.target.result);
                    loading.classList.remove('visible');
                    uploadOverlay.classList.add('hidden');
                    showToast(`Loaded ${rawGpsData.length} GPS, ${accData.length} ACC, ${rotData.length} ROT`);
                } catch (err) {
                    console.error(err);
                    loading.classList.remove('visible');
                    showToast('Error: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        // ==================== CSV Parsing ====================
        function parseCSV(csvText) {
            csvText = csvText.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            const lines = csvText.trim().split('\n');
            const headerLine = lines[0];
            const delimiter = headerLine.includes('\t') ? '\t' : ',';
            const headers = headerLine.split(delimiter).map(h => h.trim());

            const cols = {};
            ['rtc_unix_s', 't_us', 'event', 'v1', 'v2', 'v3', 'v4', 'v5', 'v6', 
             'lat', 'lon', 'alt_m', 'speed_mps', 'course_deg', 'hdop', 'num_sats'].forEach(h => {
                cols[h] = headers.indexOf(h);
            });

            rawGpsData = []; accData = []; gyroData = []; rotData = [];
            let baseOffset = 0, foundBase = false;

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const v = line.split(delimiter);
                const event = v[cols.event]?.trim();
                const rtc = parseInt(v[cols.rtc_unix_s]) || 0;
                const t_us = parseInt(v[cols.t_us]) || 0;

                if (rtc > 0 && !foundBase) { baseOffset = t_us; foundBase = true; }
                const relTime = (t_us - baseOffset) / 1000;

                if (event === 'GPS') {
                    const lat = parseFloat(v[cols.lat]), lon = parseFloat(v[cols.lon]);
                    if (!isNaN(lat) && !isNaN(lon) && lat !== 0 && lon !== 0) {
                        rawGpsData.push({
                            time: relTime, lat, lon,
                            alt: parseFloat(v[cols.alt_m]) || 0,
                            speed: parseFloat(v[cols.speed_mps]) || 0,
                            course: parseFloat(v[cols.course_deg]) || 0,
                            hdop: parseFloat(v[cols.hdop]) || 0,
                            sats: parseInt(v[cols.num_sats]) || 0
                        });
                    }
                } else if (event === 'ACC') {
                    accData.push({ time: relTime, x: parseFloat(v[cols.v1]) || 0, y: parseFloat(v[cols.v2]) || 0, z: parseFloat(v[cols.v3]) || 0 });
                } else if (event === 'GYRO') {
                    gyroData.push({ time: relTime, x: parseFloat(v[cols.v1]) || 0, y: parseFloat(v[cols.v2]) || 0, z: parseFloat(v[cols.v3]) || 0 });
                } else if (event === 'ROT') {
                    // Quaternion data: x, y, z, w
                    rotData.push({
                        time: relTime,
                        x: parseFloat(v[cols.v1]) || 0,
                        y: parseFloat(v[cols.v2]) || 0,
                        z: parseFloat(v[cols.v3]) || 0,
                        w: parseFloat(v[cols.v4]) || 1
                    });
                }
            }

            if (rawGpsData.length > 0) {
                const startTime = rawGpsData[0].time;
                rawGpsData.forEach(p => p.time -= startTime);
                accData.forEach(p => p.time -= startTime);
                gyroData.forEach(p => p.time -= startTime);
                rotData.forEach(p => p.time -= startTime);
                
                accData = accData.filter(p => p.time >= 0);
                gyroData = gyroData.filter(p => p.time >= 0);
                rotData = rotData.filter(p => p.time >= 0);
                
                applyDataFilters();
            } else {
                showToast('No GPS data found', 'error');
            }
        }

        // ==================== Filtering ====================
        filterBtn.addEventListener('click', () => {
            filterPanel.classList.toggle('visible');
            filterBtn.classList.toggle('active');
        });

        const maxSpeedFilter = document.getElementById('maxSpeedFilter');
        const minSatsFilter = document.getElementById('minSatsFilter');
        const maxHdopFilter = document.getElementById('maxHdopFilter');
        const removeStationaryChk = document.getElementById('removeStationary');
        const removeJumpsChk = document.getElementById('removeJumps');

        maxSpeedFilter.addEventListener('input', (e) => { document.getElementById('maxSpeedValue').textContent = e.target.value; updateFilterPreview(); });
        minSatsFilter.addEventListener('input', (e) => { document.getElementById('minSatsValue').textContent = e.target.value; updateFilterPreview(); });
        maxHdopFilter.addEventListener('input', (e) => { document.getElementById('maxHdopValue').textContent = e.target.value; updateFilterPreview(); });
        removeStationaryChk.addEventListener('change', updateFilterPreview);
        removeJumpsChk.addEventListener('change', updateFilterPreview);

        function updateFilterPreview() {
            const filtered = filterData(rawGpsData, getFilterSettings());
            document.getElementById('filteredCount').textContent = filtered.length;
            document.getElementById('totalCount').textContent = rawGpsData.length;
        }

        function getFilterSettings() {
            return {
                maxSpeed: parseFloat(maxSpeedFilter.value),
                minSats: parseInt(minSatsFilter.value),
                maxHdop: parseFloat(maxHdopFilter.value),
                removeStationary: removeStationaryChk.checked,
                removeJumps: removeJumpsChk.checked
            };
        }

        function filterData(data, f) {
            let filtered = data.filter(p => p.speed <= f.maxSpeed && p.sats >= f.minSats && p.hdop <= f.maxHdop && !(f.removeStationary && p.speed === 0));
            if (f.removeJumps && filtered.length > 1) {
                const cleaned = [filtered[0]];
                for (let i = 1; i < filtered.length; i++) {
                    if (haversineDistance(filtered[i-1].lat, filtered[i-1].lon, filtered[i].lat, filtered[i].lon) <= 100) cleaned.push(filtered[i]);
                }
                filtered = cleaned;
            }
            return filtered;
        }

        function applyDataFilters() {
            gpsData = filterData(rawGpsData, getFilterSettings());
            if (gpsData.length > 1) {
                stopPlayback();
                currentIndex = 0;
                accumulatedTime = 0;

                // Build IMU master timeline (ROT-time) with interpolated GPS
                imuTimeline = [];
                if (rotData.length > 0) {
                    for (const r of rotData) {
                        const gpsInterp = interpGpsAtTime(gpsData, r.time);
                        if (!gpsInterp) continue;

                        imuTimeline.push({
                            time: r.time,
                            // interpolated GPS fields
                            lat: gpsInterp.lat,
                            lon: gpsInterp.lon,
                            alt: gpsInterp.alt,
                            speed: gpsInterp.speed,
                            course: gpsInterp.course,
                            hdop: gpsInterp.hdop,
                            sats: gpsInterp.sats,
                            // keep quaternion sample
                            rot: { x: r.x, y: r.y, z: r.z, w: r.w }
                        });
                    }
                }

                // Fallback if no ROT data: keep old GPS-only playback
                if (imuTimeline.length < 2) {
                    showToast('No ROT data for IMU-timeline playback (using GPS timeline)', 'error');
                    imuTimeline = gpsData.map(p => ({
                        time: p.time,
                        lat: p.lat, lon: p.lon, alt: p.alt, speed: p.speed, course: p.course, hdop: p.hdop, sats: p.sats,
                        rot: null
                    }));
                }

                displayRoute();
                updateStats();
                updateFilterPreview();
                if (graphsVisible) initCharts();

                // Ensure marker + HUD initialised from IMU timeline
                updatePosition(0);
            } else {
                showToast('Not enough GPS points', 'error');
            }
        }

        document.getElementById('applyFilters').addEventListener('click', () => {
            applyDataFilters();
            filterPanel.classList.remove('visible');
            filterBtn.classList.remove('active');
            showToast(`Applied: ${gpsData.length} points`);
        });

        // ==================== Route Display ====================
        function displayRoute() {
            if (routeLine) map.removeLayer(routeLine);
            if (positionMarker) map.removeLayer(positionMarker);
            if (startMarker) map.removeLayer(startMarker);
            if (endMarker) map.removeLayer(endMarker);

            const coords = gpsData.map(p => [p.lat, p.lon]);
            routeLine = L.polyline(coords, { color: '#00d4ff', weight: 4, opacity: 0.8 }).addTo(map);
            startMarker = L.marker(coords[0], { icon: L.divIcon({ className: 'start-marker', iconSize: [14, 14], iconAnchor: [7, 7] }) }).addTo(map);
            endMarker = L.marker(coords[coords.length - 1], { icon: L.divIcon({ className: 'end-marker', iconSize: [14, 14], iconAnchor: [7, 7] }) }).addTo(map);
            positionMarker = L.marker(coords[0], { icon: L.divIcon({ className: 'custom-marker position-marker', iconSize: [18, 18], iconAnchor: [9, 9] }), zIndexOffset: 1000 }).addTo(map);
            map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });
            updatePosition(0); // sets marker + info + timeline + 3D from IMU timeline
        }

        // ==================== Stats ====================
        function updateStats() {
            document.getElementById('gpsPointsCount').textContent = gpsData.length;
            const totalTimeMs = imuTimeline.length ? imuTimeline[imuTimeline.length - 1].time : 0;
            document.getElementById('totalDuration').textContent = formatTime(totalTimeMs);
            endTimeEl.textContent = formatTime(totalTimeMs);
            let dist = 0;
            for (let i = 1; i < gpsData.length; i++) dist += haversineDistance(gpsData[i-1].lat, gpsData[i-1].lon, gpsData[i].lat, gpsData[i].lon);
            document.getElementById('totalDistance').textContent = (dist / 1000).toFixed(2) + ' km';
        }

        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000, dLat = (lat2 - lat1) * Math.PI / 180, dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function formatTime(ms) {
            const s = Math.floor(ms / 1000);
            return `${Math.floor(s / 60).toString().padStart(2, '0')}:${(s % 60).toString().padStart(2, '0')}`;
        }

        function findClosestData(data, time) {
            if (!data.length) return null;
            let closest = data[0], minDiff = Math.abs(data[0].time - time);
            for (const d of data) {
                const diff = Math.abs(d.time - time);
                if (diff < minDiff) { minDiff = diff; closest = d; }
                if (d.time > time + 100) break;
            }
            return closest;
        }

        // Find the bracketing GPS points for time t (ms). Returns {a,b,alpha} or null.
        function findGpsBracket(gpsArr, t) {
            if (!gpsArr || gpsArr.length < 2) return null;
            if (t <= gpsArr[0].time) return { a: gpsArr[0], b: gpsArr[0], alpha: 0 };
            const last = gpsArr[gpsArr.length - 1];
            if (t >= last.time) return { a: last, b: last, alpha: 0 };

            // Binary search for rightmost point with time <= t
            let lo = 0, hi = gpsArr.length - 1;
            while (lo <= hi) {
                const mid = (lo + hi) >> 1;
                if (gpsArr[mid].time <= t) lo = mid + 1;
                else hi = mid - 1;
            }
            const i = Math.max(0, hi);
            const a = gpsArr[i];
            const b = gpsArr[Math.min(i + 1, gpsArr.length - 1)];

            const dt = (b.time - a.time);
            const alpha = dt > 0 ? (t - a.time) / dt : 0;
            return { a, b, alpha: Math.max(0, Math.min(1, alpha)) };
        }

        function lerp(a, b, alpha) {
            return a + (b - a) * alpha;
        }

        // Interpolate GPS fields at IMU time t (ms). Returns an object with lat/lon/etc.
        function interpGpsAtTime(gpsArr, t) {
            const br = findGpsBracket(gpsArr, t);
            if (!br) return null;
            const { a, b, alpha } = br;

            // Linear interpolation of common fields
            return {
                time: t,
                lat:    lerp(a.lat,    b.lat,    alpha),
                lon:    lerp(a.lon,    b.lon,    alpha),
                alt:    lerp(a.alt,    b.alt,    alpha),
                speed:  lerp(a.speed,  b.speed,  alpha),
                course: lerp(a.course, b.course, alpha),
                hdop:   lerp(a.hdop,   b.hdop,   alpha),
                sats:   Math.round(lerp(a.sats,  b.sats,  alpha)) // sats is integer-like
            };
        }


        // ==================== Playback ====================
        playBtn.addEventListener('click', togglePlayback);
        document.getElementById('skipBackBtn').addEventListener('click', () => seekTo(0));
        document.getElementById('skipEndBtn').addEventListener('click', () => seekTo(imuTimeline.length - 1));

        speedBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                speedBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                playbackSpeed = parseInt(btn.dataset.speed);
            });
        });

        function togglePlayback() {
            if (imuTimeline.length === 0) return;
            isPlaying = !isPlaying;
            if (isPlaying) {
                playIcon.innerHTML = '<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>';
                playBtn.classList.add('playing');
                lastTimestamp = performance.now();
                if (currentIndex >= imuTimeline.length - 1) { currentIndex = 0; accumulatedTime = 0; }
                animatePlayback();
            } else {
                stopPlayback();
            }
        }

        function stopPlayback() {
            isPlaying = false;
            playIcon.innerHTML = '<path d="M8 5v14l11-7z"/>';
            playBtn.classList.remove('playing');
            if (animationFrame) cancelAnimationFrame(animationFrame);
        }

        function animatePlayback() {
            if (!isPlaying) return;
            const now = performance.now();
            accumulatedTime += (now - lastTimestamp) * playbackSpeed;
            lastTimestamp = now;

            // Advance IMU index based on IMU timeline timestamps
            let targetIdx = currentIndex;
            while (targetIdx < imuTimeline.length - 1 && imuTimeline[targetIdx + 1].time <= accumulatedTime) {
                targetIdx++;
            }

            if (targetIdx !== currentIndex) {
                currentIndex = targetIdx;
                updatePosition(currentIndex);
            } else if (currentIndex < imuTimeline.length - 1) {
                // Optional: interpolate between adjacent IMU-timeline points for extra smooth marker motion
                const p1 = imuTimeline[currentIndex];
                const p2 = imuTimeline[currentIndex + 1];
                const dt = (p2.time - p1.time);
                const prog = dt > 0 ? (accumulatedTime - p1.time) / dt : 0;

                if (prog >= 0 && prog <= 1 && positionMarker) {
                    const lat = p1.lat + (p2.lat - p1.lat) * prog;
                    const lon = p1.lon + (p2.lon - p1.lon) * prog;
                    positionMarker.setLatLng([lat, lon]);

                    updateTimeline(accumulatedTime);
                    updateBikeRotationFromTimeline(accumulatedTime);
                }
            }

            if (currentIndex >= imuTimeline.length - 1) {
                stopPlayback();
                return;
            }

            animationFrame = requestAnimationFrame(animatePlayback);
        }

        function updatePosition(index) {
            if (index < 0 || index >= imuTimeline.length) return;
            const p = imuTimeline[index];

            if (positionMarker) positionMarker.setLatLng([p.lat, p.lon]);

            updatePositionInfo(index);
            updateTimeline(p.time);

            // Prefer timeline rot sample if available
            if (p.rot) applyRotationToModel(p.rot);
            else updateBikeRotation(p.time);
        }

        function updatePositionInfo(index) {
            const p = imuTimeline[index];
            if (!p) return;  // prevents crash if index out of bounds for any reason

            const speedUnit = document.getElementById('speedUnit')?.value || 'mps';
            let speed = p.speed ?? 0, unit = 'm/s';
            if (speedUnit === 'kmh') { speed *= 3.6; unit = 'km/h'; }
            else if (speedUnit === 'mph') { speed *= 2.237; unit = 'mph'; }
            document.getElementById('currentSpeedInfo').textContent = speed.toFixed(1) + ' ' + unit;

            const elevUnit = document.getElementById('elevationUnit')?.value || 'm';
            let alt = p.alt ?? 0;
            if (elevUnit === 'ft') alt *= 3.281;
            document.getElementById('currentAltitude').textContent =
                alt.toFixed(0) + ' ' + (elevUnit === 'ft' ? 'ft' : 'm');

            // G-force uses accel data at the same playback time
            const accPoint = findClosestData(accData, p.time);
            if (accPoint) {
                const gforce = Math.sqrt(accPoint.x**2 + accPoint.y**2 + accPoint.z**2) / 9.81;
                document.getElementById('currentGForce').textContent = gforce.toFixed(2) + ' G';
            } else {
                document.getElementById('currentGForce').textContent = '-- G';
            }
        }

        function updateTimeline(time) {
            if (imuTimeline.length === 0) return;
            const total = imuTimeline[imuTimeline.length - 1].time;
            const prog = total > 0 ? (time / total) * 100 : 0;
            timelineProgress.style.width = prog + '%';
            timelineScrubber.style.left = prog + '%';
            currentTimeEl.textContent = formatTime(time);
        }

        function seekTo(index) {
            if (imuTimeline.length === 0) return;
            currentIndex = Math.max(0, Math.min(index, imuTimeline.length - 1));
            accumulatedTime = imuTimeline[currentIndex].time;
            updatePosition(currentIndex);
        }

        function seekToTime(time) {
            if (imuTimeline.length === 0) return;
            let idx = 0;
            for (let i = 0; i < imuTimeline.length; i++) {
                if (imuTimeline[i].time <= time) idx = i;
                else break;
            }
            seekTo(idx);
        }

        // Timeline scrubbing
        let isDragging = false;
        timelineTrack.addEventListener('mousedown', e => { isDragging = true; scrub(e); });
        document.addEventListener('mousemove', e => { if (isDragging) scrub(e); });
        document.addEventListener('mouseup', () => isDragging = false);

        function scrub(e) {
            if (imuTimeline.length === 0) return;
            const rect = timelineTrack.getBoundingClientRect();
            const prog = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
            seekToTime(prog * imuTimeline[imuTimeline.length - 1].time);
        }

        // ==================== Graphs ====================
        graphsBtn.addEventListener('click', () => {
            graphsVisible = !graphsVisible;
            graphsBtn.classList.toggle('active', graphsVisible);
            dataPanels.style.display = graphsVisible ? 'block' : 'none';
            if (graphsVisible && gpsData.length > 0) setTimeout(() => initCharts(), 100);
        });

        document.querySelectorAll('.panel-header').forEach(header => {
            header.addEventListener('click', (e) => {
                if (e.target.closest('.unit-selector')) return;
                header.closest('.data-panel').classList.toggle('expanded');
            });
        });

        document.getElementById('elevationUnit')?.addEventListener('change', () => updateElevationChart());
        document.getElementById('speedUnit')?.addEventListener('change', () => updateSpeedChart());

        function initCharts() {
            Object.values(charts).forEach(c => c?.destroy());
            charts = {};

            createChart('elevationChart', 'elevation', { label: 'Elevation', data: gpsData.map(p => ({ x: p.time, y: p.alt })), color: '#10b981', yLabel: 'm' });
            createChart('speedChart', 'speed', { label: 'Speed', data: gpsData.map(p => ({ x: p.time, y: p.speed })), color: '#f59e0b', yLabel: 'm/s' });
            createMultiLineChart('accelChart', 'acceleration', [
                { label: 'X', data: accData.map(p => ({ x: p.time, y: p.x })), color: '#ef4444' },
                { label: 'Y', data: accData.map(p => ({ x: p.time, y: p.y })), color: '#22c55e' },
                { label: 'Z', data: accData.map(p => ({ x: p.time, y: p.z })), color: '#3b82f6' }
            ], 'm/s¬≤');
            createChart('gforceChart', 'gforce', { label: 'G-Force', data: accData.map(p => ({ x: p.time, y: Math.sqrt(p.x**2 + p.y**2 + p.z**2) / 9.81 })), color: '#ec4899', yLabel: 'G' });
            createMultiLineChart('gyroChart', 'gyroscope', [
                { label: 'X', data: gyroData.map(p => ({ x: p.time, y: p.x })), color: '#f97316' },
                { label: 'Y', data: gyroData.map(p => ({ x: p.time, y: p.y })), color: '#a855f7' },
                { label: 'Z', data: gyroData.map(p => ({ x: p.time, y: p.z })), color: '#06b6d4' }
            ], 'rad/s');
            createChart('headingChart', 'heading', { label: 'Course', data: gpsData.map(p => ({ x: p.time, y: p.course })), color: '#00d4ff', yLabel: '¬∞' });
        }

        function createChart(canvasId, name, config) {
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            if (!ctx) return;
            charts[name] = new Chart(ctx, {
                type: 'line',
                data: { datasets: [{ label: config.label, data: config.data, borderColor: config.color, backgroundColor: config.color + '20', borderWidth: 1.5, pointRadius: 0, fill: true, tension: 0.3 }] },
                options: getChartOptions(config.yLabel, name)
            });
        }

        function createMultiLineChart(canvasId, name, datasets, yLabel) {
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            if (!ctx) return;
            charts[name] = new Chart(ctx, {
                type: 'line',
                data: { datasets: datasets.map(ds => ({ label: ds.label, data: ds.data, borderColor: ds.color, borderWidth: 1.5, pointRadius: 0, fill: false, tension: 0.3 })) },
                options: getChartOptions(yLabel, name)
            });
        }

        function getChartOptions(yLabel, chartName) {
            return {
                responsive: true, maintainAspectRatio: false,
                interaction: { intersect: false, mode: 'index' },
                onClick: (e, elements, chart) => {
                    const x = chart.scales.x.getValueForPixel(e.native.offsetX);
                    if (x !== undefined) seekToTime(x);
                },
                plugins: {
                    legend: { display: chartName === 'acceleration' || chartName === 'gyroscope', labels: { color: '#a0a0b0', boxWidth: 12, padding: 8, font: { size: 10 } } },
                    tooltip: { backgroundColor: '#1a1a25', titleColor: '#fff', bodyColor: '#a0a0b0', borderColor: '#2a2a3a', borderWidth: 1,
                        callbacks: { title: items => formatTime(items[0].parsed.x), label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(2)} ${yLabel}` } }
                },
                scales: {
                    x: { type: 'linear', grid: { color: '#2a2a3a' }, ticks: { color: '#606070', font: { size: 9 }, callback: v => formatTime(v), maxTicksLimit: 8 } },
                    y: { grid: { color: '#2a2a3a' }, ticks: { color: '#606070', font: { size: 9 }, callback: v => v.toFixed(1) } }
                }
            };
        }

        function updateElevationChart() {
            if (!charts.elevation) return;
            const mult = document.getElementById('elevationUnit').value === 'ft' ? 3.281 : 1;
            charts.elevation.data.datasets[0].data = gpsData.map(p => ({ x: p.time, y: p.alt * mult }));
            charts.elevation.update('none');
        }

        function updateSpeedChart() {
            if (!charts.speed) return;
            const unit = document.getElementById('speedUnit').value;
            let mult = 1;
            if (unit === 'kmh') mult = 3.6;
            else if (unit === 'mph') mult = 2.237;
            charts.speed.data.datasets[0].data = gpsData.map(p => ({ x: p.time, y: p.speed * mult }));
            charts.speed.update('none');
        }

        // ==================== Keyboard ====================
        document.addEventListener('keydown', (e) => {
            if (imuTimeline.length === 0) return;
            switch(e.code) {
                case 'Space': e.preventDefault(); togglePlayback(); break;
                case 'ArrowLeft': seekTo(Math.max(0, currentIndex - 1)); break;
                case 'ArrowRight': seekTo(Math.min(imuTimeline.length - 1, currentIndex + 1)); break;
                case 'Home': seekTo(0); break;
                case 'End': seekTo(imuTimeline.length - 1); break;
            }
        });

        document.addEventListener('click', (e) => {
            if (!filterPanel.contains(e.target) && !filterBtn.contains(e.target)) {
                filterPanel.classList.remove('visible');
                filterBtn.classList.remove('active');
            }
        });

        // ==================== 3D Panel Resize Drag ====================
        let isResizing3dPanel = false;

        viewer3dResizeHandle?.addEventListener('mousedown', (e) => {
            if (!viewer3dVisible) return;
            isResizing3dPanel = true;
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing3dPanel) return;

            // Panel is on the right; width = viewportRight - mouseX
            const newWidth = window.innerWidth - e.clientX;

            // Clamp to sensible range
            const clamped = Math.max(240, Math.min(700, newWidth));
            viewer3dPanel.style.width = clamped + 'px';

            // Update renderer sizing
            resize3DViewer();
        });

        document.addEventListener('mouseup', () => {
            isResizing3dPanel = false;
        });


        window.addEventListener('resize', () => { if (viewer3dVisible) resize3DViewer(); });

        // ==================== Init ====================
        initMap();
        updateFilterPreview();
    </script>
</body>
</html>